//请求延迟的时间ms，如果时长小于0将会并发
var REQUEST_DELAY = -1;
var hostUrl = "https://www.qidian.com/";
function search(http,query){
    var baseUrl = hostUrl;
    var html = http.get(baseUrl + "soushu/" + URLEncoder.encode(query, "utf-8"))+".html";
    var parse = Jsoup.parse(html,baseUrl);
    var bookListEl = parse.select(".res-book-item");
    var results = new ArrayList();
    for (var i=0;i<bookListEl.size();i++){
        var bookEl = bookListEl.get(i);
        var result = new SearchResult();
        result.source = source;
        result.bookTitle = bookEl.selectFirst(".book-info-title a").text();
        result.bookUrl = bookEl.selectFirst(".book-info-title a").absUrl("href");
        result.bookAuthor = bookEl.selectFirst(".author a").text();
        results.add(result);
    }
    return results;
}

/**
 * 书籍详情[JavaScript.source]
 */
function getDetails(http,url){
    var parse = Jsoup.parse(http.get(url),url);
    var book = new Book();
    book.source = source;

    book.url = url;
    book.title = parse.selectFirst(".book-info h1 em").text();
    book.author = parse.selectFirst(".book-info h1 span a").text();
    book.intro = parse.selectFirst(".book-intro").text();
    book.cover = parse.selectFirst(".book-information .book-img img").absUrl("src");
    //加载章节列表
    var children = parse.select("li[data-rid] > h2[class='book_name'] a");
    var chapterList = new ArrayList();
    for(i=0; i<children.size(); i++){
        var chapterEl = children.get(i);
        var chapter = new Chapter();
        chapter.title = chapterEl.text();
        chapter.url = chapterEl.absUrl("href");
        chapterList.add(chapter);
    }
    book.chapterList = chapterList;
    return book;
}

function getChapterContent(http,url){
    var html = http.get(url);
    if (url.startsWith("https://m.qidian.com/")) {
        return Jsoup.parse(html).select("section.read-section.jsChapterWrapper > p").outerHtml();
    } else {
        return Jsoup.parse(html).select(".main-text-wrap  div.read-content").html();
    }
}